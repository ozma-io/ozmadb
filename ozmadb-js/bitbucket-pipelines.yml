pipelines:
  default:
    - step: &build
        name: Build
        image: node:lts
        caches:
          - node
          - yarn
        script:
          - ./build.sh
          - ./lint.sh
        artifacts:
          - dist/**
          - bundle/**
  pull-requests:
    '**':
      - step: *build
  branches:
    master:
      - step: *build
      - step:
          name: Upload
          caches:
            - docker
          script:
            - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_PASSWORD"
            # Workaround for pipes not supporting private docker repos.
            - docker pull myprocessx/upload-artifact
            - pipe: ozma-io/upload-artifact:master
              variables:
                LOCAL_PATH: bundle
          artifacts:
            - artifact.json
      - step:
          name: Deploy to test
          deployment: test
          caches:
            - docker
          script:
            - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_PASSWORD"
            - docker pull myprocessx/deploy-artifact
            - pipe: ozma-io/deploy-artifact:master
      - step:
          name: Deploy to production
          deployment: production
          trigger: manual
          caches:
            - docker
          script:
            - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_PASSWORD"
            - docker pull myprocessx/deploy-artifact
            - pipe: ozma-io/deploy-artifact:master

definitions:
  caches:
    yarn: /usr/local/share/.cache/yarn
